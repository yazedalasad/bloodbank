{% extends 'donors/base.html' %}
{% block content %}

<div class="row">
  <!-- Main Content -->
  <div class="col-md-9">
    <div class="card shadow-lg mb-4">
      <div class="card-header bg-danger text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h3><i class="fas fa-users me-2"></i>רשימת תורמים</h3>
          <a href="{% url 'donor_create' %}" class="btn btn-light btn-sm">
            <i class="fas fa-user-plus me-1"></i> תורם חדש
          </a>
        </div>
      </div>
      
      <!-- Search and Filter Bar -->
      <div class="card-body border-bottom">
        <form method="get" class="row g-3">
          <div class="col-md-5">
            <div class="input-group">
              <input type="text" class="form-control" name="q" value="{{ search_query }}" 
                     placeholder="חיפוש לפי תעודת זהות...">
              <button class="btn btn-outline-danger" type="submit">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-5">
            <select name="blood_type" class="form-select">
              <option value="">כל סוגי הדם</option>
              {% for code, name in blood_types %}
                <option value="{{ code }}" {% if blood_type_filter == code %}selected{% endif %}>
                  {{ name }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-danger w-100">סנן</button>
          </div>
        </form>
      </div>
      
      <!-- Donors Table -->
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>שם מלא</th>
              <th>תעודת זהות</th>
              <th>סוג דם</th>
              <th>טלפון</th>
              <th class="text-end">סה"כ תרומות</th>
              <th class="text-end">תרומה אחרונה</th>
            </tr>
          </thead>
          <tbody>
            {% for donor in donors %}
            <tr>
              <td>
                <strong>{{ donor.last_name }}, {{ donor.first_name }}</strong>
                {% if donor.age %}
                  <br><small class="text-muted">{{ donor.age }} שנים</small>
                {% endif %}
              </td>
              <td>{{ donor.national_id }}</td>
              <td>
                <span class="badge bg-danger rounded-pill">
                  {{ donor.blood_type }}
                </span>
              </td>
              <td>{{ donor.phone_number }}</td>
              <td class="text-end">
                {{ donor.total_donated|default:"0" }} מ"ל
              </td>
              <td class="text-end">
                {% if donor.last_donation %}
                  {{ donor.last_donation|date:"d/m/Y" }}
                {% else %}
                  <span class="text-muted">אין נתונים</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="fas fa-user-slash fa-2x mb-2 text-muted"></i>
                <p class="h5 text-muted">לא נמצאו תורמים</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      {% if donors.paginator.num_pages > 1 %}
      <div class="card-footer">
        <nav aria-label="Donor pagination">
          <ul class="pagination justify-content-center mb-0">
            {% if donors.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?page={{ donors.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if blood_type_filter %}&blood_type={{ blood_type_filter }}{% endif %}">
                  &laquo; הקודם
                </a>
              </li>
            {% endif %}
            
            {% for num in donors.paginator.page_range %}
              {% if donors.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
              {% else %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ num }}{% if search_query %}&q={{ search_query }}{% endif %}{% if blood_type_filter %}&blood_type={{ blood_type_filter }}{% endif %}">
                    {{ num }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}
            
            {% if donors.has_next %}
              <li class="page-item">
                <a class="page-link" href="?page={{ donors.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if blood_type_filter %}&blood_type={{ blood_type_filter }}{% endif %}">
                  הבא &raquo;
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Sidebar Stats -->
  <div class="col-md-3">
    <div class="card shadow-sm sticky-top" style="top: 20px;">
      <div class="card-header bg-danger text-white">
        <h4><i class="fas fa-chart-pie me-2"></i>סטטיסטיקות</h4>
      </div>
      <div class="card-body">
        <div class="alert alert-info">
          <h5 class="alert-heading">סיכום תורמים</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              סה"כ תורמים
              <span class="badge bg-primary rounded-pill">{{ donor_stats.total }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              תורמי O-
              <span class="badge bg-danger rounded-pill">{{ donor_stats.o_negative }}</span>
            </li>
          </ul>
        </div>
        
        <div class="alert alert-warning">
          <h5 class="alert-heading">חלוקת סוגי דם</h5>
          {% for item in donor_stats.blood_type_distribution %}
            <div class="d-flex justify-content-between mb-1">
              <span>{{ item.blood_type }}</span>
              <span class="fw-bold">{{ item.count }} ({{ item.percentage }}%)</span>
            </div>
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar bg-danger" role="progressbar" 
                   role="progressbar" 
                   data-width="{{ item.percentage }}"
                   aria-valuenow="{{ item.count }}" 
                   aria-valuemin="0" 
                   aria-valuemax="{{ donor_stats.total }}">
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
<script>
document.querySelectorAll('.progress-bar').forEach(bar => {
    const percentage = parseFloat(bar.dataset.percentage);
    bar.style.width = `${Math.min(100, percentage)}%`;
});
</script>

{% endblock %}