{% extends 'donors/base.html' %}
{% block content %}

<style>
.emergency-alert {
    background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
    border: none;
    border-radius: 15px;
    color: white;
    box-shadow: 0 10px 30px rgba(255, 0, 0, 0.3);
}

.emergency-card {
    border: 3px solid #dc3545;
    border-radius: 15px;
    box-shadow: 0 15px 35px rgba(220, 53, 69, 0.2);
}

.emergency-btn {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
    padding: 20px;
    font-size: 1.5rem;
    font-weight: bold;
    border-radius: 12px;
    transition: all 0.3s ease;
}

.emergency-btn:hover:not(:disabled) {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(220, 53, 69, 0.4);
}

.emergency-btn:disabled {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    cursor: not-allowed;
    opacity: 0.6;
}

.stats-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border-left: 4px solid #dc3545;
}

.unit-counter {
    font-size: 3rem;
    font-weight: bold;
    color: #dc3545;
}

.sidebar-info {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    color: white;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
}

.info-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    padding: 10px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
}

.info-icon {
    width: 40px;
    height: 40px;
    background: #dc3545;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 15px;
    flex-shrink: 0;
}

.quick-stats {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
}

.stat-number {
    font-size: 2rem;
    font-weight: bold;
    color: #00bc8c;
}

.stat-number-zero {
    font-size: 2rem;
    font-weight: bold;
    color: #dc3545;
}

.alert-status {
    background: rgba(220, 53, 69, 0.2);
    border: 2px solid #dc3545;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
}

.status-indicator {
    width: 15px;
    height: 15px;
    border-radius: 50%;
    display: inline-block;
    margin-left: 10px;
}

.status-active {
    background: #00bc8c;
    box-shadow: 0 0 10px #00bc8c;
}

.status-warning {
    background: #f39c12;
    box-shadow: 0 0 10px #f39c12;
}

.status-critical {
    background: #e74c3c;
    box-shadow: 0 0 10px #e74c3c;
    animation: pulse 2s infinite;
}

.status-offline {
    background: #6c757d;
    box-shadow: 0 0 10px #6c757d;
}

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

.availability-alert {
    border-radius: 12px;
    border: 3px solid #dc3545;
    background: rgba(220, 53, 69, 0.1);
}

.donation-rules {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 2px solid #ffc107;
    border-radius: 10px;
    padding: 15px;
    margin-top: 20px;
}
</style>

<div class="container-fluid py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Emergency Alert -->
            <div class="alert emergency-alert text-center mb-4">
                <h1 class="mb-2"><i class="fas fa-exclamation-triangle me-2"></i>בקשת חירום</h1>
                <p class="mb-0">מערכת אוטומטית לאיסוף דם מסוג O- (תורם אוניברסלי)</p>
            </div>

            <!-- No Available Donors Warning -->
            {% if available_units == 0 %}
            <div class="alert availability-alert text-center mb-4">
                <h4><i class="fas fa-ban me-2"></i>אזהרה: אין תורמים זמינים</h4>
                <p class="mb-2">
                    <strong>אין תורמי O- שיכולים לתרום כרגע.</strong>
                </p>
                <p class="mb-0">
                    כל התורמים תרמו לאחרונה וחייבים להמתין 56 יום בין תרומות לפי הנחיות משרד הבריאות.
                </p>
            </div>
            {% endif %}

            <div class="card emergency-card mb-4">
                <div class="card-header bg-danger text-white py-3">
                    <h3 class="mb-0"><i class="fas fa-tint me-2"></i>בקשת דם חירום</h3>
                </div>
                <div class="card-body p-4">
                    <form method="post" id="emergencyForm">
                        {% csrf_token %}
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fs-5">
                                    <i class="fas fa-blood me-2"></i>מספר יחידות דם נדרש
                                </label>
                                <input type="number" name="units_needed" class="form-control form-control-lg" 
                                       min="1" max="{{ available_units }}" required 
                                       placeholder="הזן מספר יחידות"
                                       {% if available_units == 0 %}disabled{% endif %}>
                                <div class="form-text">
                                    {% if available_units == 0 %}
                                        <span class="text-danger">
                                            <i class="fas fa-exclamation-circle me-1"></i>
                                            אין יחידות זמינות כרגע
                                        </span>
                                    {% else %}
                                        <span class="text-success">
                                            <i class="fas fa-check-circle me-1"></i>
                                            מקסימום {{ available_units }} יחידות זמינות
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Additional Emergency Fields -->
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-user me-2"></i>שם איש קשר
                                </label>
                                <input type="text" name="contact_name" class="form-control" 
                                       placeholder="הזן שם מלא" required
                                       {% if available_units == 0 %}disabled{% endif %}>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-phone me-2"></i>טלפון להתקשרות
                                </label>
                                <input type="tel" name="contact_phone" class="form-control" 
                                       placeholder="הזן מספר טלפון" required
                                       {% if available_units == 0 %}disabled{% endif %}>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-hospital me-2"></i>בית חולים/מיקום
                                </label>
                                <input type="text" name="hospital" class="form-control" 
                                       placeholder="הזן מיקום" required
                                       {% if available_units == 0 %}disabled{% endif %}>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">
                                    <i class="fas fa-heartbeat me-2"></i>קשר למטופל
                                </label>
                                <select name="contact_relationship" class="form-select" required
                                        {% if available_units == 0 %}disabled{% endif %}>
                                    <option value="family">בן משפחה</option>
                                    <option value="friend">חבר/מכר</option>
                                    <option value="medical_staff">צוות רפואי</option>
                                    <option value="other">אחר</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">
                                    <i class="fas fa-stethoscope me-2"></i>רמת חירום
                                </label>
                                <select name="emergency_level" class="form-select" required
                                        {% if available_units == 0 %}disabled{% endif %}>
                                    <option value="critical">מצב קריטי</option>
                                    <option value="urgent">דחוף</option>
                                    <option value="stable">יציב אך דורש דם</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label class="form-label">
                                    <i class="fas fa-notes-medical me-2"></i>הערות נוספות
                                </label>
                                <textarea name="notes" class="form-control" rows="3" 
                                          placeholder="פרטים נוספים על המצב (רשות)"
                                          {% if available_units == 0 %}disabled{% endif %}></textarea>
                            </div>
                            
                            <div class="col-12">
                                <div class="alert {% if available_units == 0 %}alert-danger{% else %}alert-warning{% endif %}">
                                    <h5><i class="fas fa-info-circle me-2"></i>מידע חשוב:</h5>
                                    <ul class="mb-0">
                                        <li>המערכת תפנה אוטומטית לתורמי O-</li>
                                        <li>כל תורם יכול לתת עד יחידה אחת בחירום</li>
                                        <li>יתקבל אישור מיידי עם פירוט התרומות</li>
                                        <li>פטור מאישור רפואי עבור תורמי O- בחירום</li>
                                        {% if available_units == 0 %}
                                        <li class="text-danger fw-bold">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            אין תורמים זמינים כרגע - נא לנסות שוב מאוחר יותר
                                        </li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn emergency-btn w-100" 
                                        {% if available_units == 0 %}disabled{% endif %}>
                                    <i class="fas fa-bolt me-2"></i>
                                    {% if available_units == 0 %}
                                        אין תורמים זמינים
                                    {% else %}
                                        בצע בקשה אוטומטית
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Recent Emergency Requests -->
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h4 class="mb-0"><i class="fas fa-history me-2"></i>בקשות חירום אחרונות</h4>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>תאריך</th>
                                    <th>יחידות</th>
                                    <th>סטטוס</th>
                                    <th>איש קשר</th>
                                    <th>רמת חירום</th>
                                    <th>מיקום</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for request in recent_requests %}
                                <tr>
                                    <td>{{ request.date_requested|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        <span class="fw-bold">{{ request.units_needed }}</span>
                                    </td>
                                    <td>
                                        {% if request.fulfilled %}
                                            <span class="badge bg-success">סופק</span>
                                        {% else %}
                                            <span class="badge bg-warning">בתהליך</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ request.contact_name }}</td>
                                    <td>
                                        {% if request.emergency_level == 'critical' %}
                                            <span class="badge bg-danger">קריטי</span>
                                        {% elif request.emergency_level == 'urgent' %}
                                            <span class="badge bg-warning">דחוף</span>
                                        {% else %}
                                            <span class="badge bg-info">יציב</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ request.hospital|truncatechars:20 }}</small>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                                        <br>
                                        <span class="text-muted">אין בקשות חירום אחרונות</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Information -->
        <div class="col-lg-4">
            <!-- Emergency Information -->
            <div class="sidebar-info">
                <h4 class="text-center mb-4">
                    <i class="fas fa-info-circle me-2"></i>מידע חירום
                </h4>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">דם O-</h6>
                        <small>תורם אוניברסלי - מתאים לכל סוגי הדם</small>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">זמן תגובה</h6>
                        <small>מערכת אוטומטית - מענה מיידי</small>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">אישור רפואי</h6>
                        <small>פטור מאישור עבור תורמי O- בחירום</small>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-exclamation"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">התראות</h6>
                        <small>כל התורמים מקבלים הודעה אוטומטית</small>
                    </div>
                </div>
            </div>

            <!-- Quick Statistics -->
            <div class="sidebar-info">
                <h4 class="text-center mb-4">
                    <i class="fas fa-chart-bar me-2"></i>סטטיסטיקות מהירות
                </h4>
                
                <div class="quick-stats">
                    <div class="text-center mb-4">
                        <div class="{% if o_negative_count > 0 %}stat-number{% else %}stat-number-zero{% endif %}">
                            {{ o_negative_count }}
                        </div>
                        <div class="text-muted">תורמי O- פעילים</div>
                    </div>
                    
                    <div class="text-center mb-4">
                        <div class="stat-number">{{ total_o_negative_units }}</div>
                        <div class="text-muted">יחידות נתרמו</div>
                    </div>
                    
                    <div class="text-center">
                        <div class="{% if available_units > 0 %}stat-number{% else %}stat-number-zero{% endif %}">
                            {{ available_units }}
                        </div>
                        <div class="text-muted">יחידות זמינות</div>
                    </div>
                </div>
                
                <div class="alert-status mt-3">
                    <h6 class="mb-3">
                        <i class="fas fa-shield-alt me-2"></i>סטטוס מערכת
                    </h6>
                    <div class="d-flex align-items-center">
                        <span class="status-indicator {% if available_units > 0 %}status-active{% else %}status-offline{% endif %}"></span>
                        <span>
                            {% if available_units > 0 %}
                                מערכת פעילה - מוכנה לחירום
                            {% else %}
                                מערכת לא זמינה - אין תורמים
                            {% endif %}
                        </span>
                    </div>
                    <div class="d-flex align-items-center mt-2">
                        <span class="status-indicator {% if o_negative_count > 0 %}status-warning{% else %}status-offline{% endif %}"></span>
                        <span>{{ o_negative_count }} תורמים רשומים</span>
                    </div>
                    <div class="d-flex align-items-center mt-2">
                        <span class="status-indicator status-critical"></span>
                        <span>עדיפות עליונה - O-</span>
                    </div>
                </div>
            </div>

            <!-- Donation Rules -->
            <div class="sidebar-info">
                <h4 class="text-center mb-4">
                    <i class="fas fa-clock me-2"></i>זמני המתנה
                </h4>
                
                <div class="donation-rules">
                    <div class="info-item">
                        <div class="info-icon" style="background: #17a2b8;">
                            <i class="fas fa-male"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">גברים</h6>
                            <small>56 יום בין תרומות</small>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon" style="background: #e83e8c;">
                            <i class="fas fa-female"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">נשים</h6>
                            <small>84 יום בין תרומות</small>
                        </div>
                    </div>
                    
                    <div class="info-item">
                        <div class="info-icon" style="background: #6f42c1;">
                            <i class="fas fa-syringe"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">תרומת טסיות</h6>
                            <small>14 יום בין תרומות</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Emergency Contacts -->
            <div class="sidebar-info">
                <h4 class="text-center mb-4">
                    <i class="fas fa-phone-alt me-2"></i>אנשי קשר חירום
                </h4>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-user-md"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">ד"ר יוסף לוי</h6>
                        <small>רכז תרומות דם</small>
                        <div class="text-warning">050-1234567</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-nurse"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">שרה כהן</h6>
                        <small>אחות אחראית</small>
                        <div class="text-warning">050-7654321</div>
                    </div>
                </div>
                
                <div class="info-item">
                    <div class="info-icon">
                        <i class="fas fa-ambulance"></i>
                    </div>
                    <div>
                        <h6 class="mb-1">חדר מיון</h6>
                        <small>קו חירום פנימי</small>
                        <div class="text-warning">*5555</div>
                    </div>
                </div>
            </div>

            <!-- Blood Compatibility Info -->
            <div class="sidebar-info">
                <h4 class="text-center mb-4">
                    <i class="fas fa-heartbeat me-2"></i>תאימות דם
                </h4>
                
                <div class="alert alert-dark text-center">
                    <h6 class="mb-2">O- → מתאים לכולם</h6>
                    <small class="text-success">תורם אוניברסלי</small>
                </div>
                
                <div class="text-center">
                    <small class="text-muted">
                        דם O- יכול להינתן לכל סוגי הדם:<br>
                        A+, A-, B+, B-, AB+, AB-, O+, O-
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Real-time validation
document.getElementById('emergencyForm').addEventListener('submit', function(e) {
    const unitsInput = document.querySelector('input[name="units_needed"]');
    const contactName = document.querySelector('input[name="contact_name"]');
    const contactPhone = document.querySelector('input[name="contact_phone"]');
    const hospital = document.querySelector('input[name="hospital"]');
    const maxUnits = parseInt('{{ available_units }}');
    
    let errors = [];
    
    if (parseInt(unitsInput.value) > maxUnits) {
        errors.push(`⚠️ אין מספיק תורמים זמינים. מקסימום ${maxUnits} יחידות זמינות.`);
    }
    
    if (parseInt(unitsInput.value) <= 0) {
        errors.push('מספר היחידות חייב להיות גדול מ-0');
    }
    
    if (!contactName.value.trim()) {
        errors.push('שם איש קשר הוא שדה חובה');
    }
    
    if (!contactPhone.value.trim()) {
        errors.push('טלפון להתקשרות הוא שדה חובה');
    }
    
    if (!hospital.value.trim()) {
        errors.push('מיקום הוא שדה חובה');
    }
    
    if (errors.length > 0) {
        e.preventDefault();
        alert(errors.join('\n'));
    }
});

// Auto-refresh stats every 30 seconds
setInterval(function() {
    fetch('/emergency/stats/')
        .then(response => response.json())
        .then(data => {
            // Update all stat numbers
            const statNumbers = document.querySelectorAll('.stat-number, .stat-number-zero');
            if (statNumbers.length >= 3) {
                // Update available donors count
                statNumbers[0].textContent = data.available_donors;
                statNumbers[0].className = data.available_donors > 0 ? 'stat-number' : 'stat-number-zero';
                
                // Update available units
                statNumbers[2].textContent = data.estimated_available_units;
                statNumbers[2].className = data.estimated_available_units > 0 ? 'stat-number' : 'stat-number-zero';
                
                // Update system status
                const statusIndicator = document.querySelector('.status-indicator');
                const statusText = document.querySelector('.alert-status .d-flex.align-items-center span:last-child');
                
                if (data.estimated_available_units > 0) {
                    statusIndicator.className = 'status-indicator status-active';
                    statusText.textContent = 'מערכת פעילה - מוכנה לחירום';
                } else {
                    statusIndicator.className = 'status-indicator status-offline';
                    statusText.textContent = 'מערכת לא זמינה - אין תורמים';
                }
            }
        })
        .catch(error => console.log('Stats refresh failed:', error));
}, 30000);

// Add input formatting for phone number
document.querySelector('input[name="contact_phone"]').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 0) {
        value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
    }
    e.target.value = value;
});

// Show/hide form based on availability
function updateFormAvailability() {
    const availableUnits = parseInt('{{ available_units }}');
    const formElements = document.querySelectorAll('#emergencyForm input, #emergencyForm select, #emergencyForm textarea, #emergencyForm button');
    
    if (availableUnits === 0) {
        formElements.forEach(element => {
            if (element.type !== 'hidden') {
                element.disabled = true;
            }
        });
    }
}

// Initialize form availability
updateFormAvailability();
</script>

{% endblock %}